name: Build Native WebView Libraries

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 3 AM UTC

defaults:
  run:
    shell: bash

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.check.outputs.ref }}
      version: ${{ steps.check.outputs.version }}
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Resolve latest master commit and check if already built
        id: check
        run: |
          ref=$(curl -s https://api.github.com/repos/webview/webview/commits/master | jq -r '.sha')
          if [ -z "$ref" ] || [ "$ref" = "null" ]; then
            echo "failed to resolve webview/webview master commit SHA" >&2
            exit 1
          fi

          short_ref="${ref:0:12}"
          version="master-${short_ref}"

          echo "ref=$ref" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

          if [ -f embedded/VERSION.txt ] && grep -Fxq "$version" embedded/VERSION.txt; then
            echo "already built version $version"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: ${{ matrix.job.os }}-${{ matrix.job.arch }}
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ${{ matrix.job.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - os: linux
            arch: amd64
            runs-on: ubuntu-latest
            file: libwebview.so
            generator: Ninja
          - os: linux
            arch: arm64
            runs-on: ubuntu-24.04-arm
            file: libwebview.so
            generator: Ninja
          - os: darwin
            arch: amd64
            runs-on: macos-latest
            file: libwebview.dylib
            args: -D CMAKE_OSX_ARCHITECTURES=x86_64
            generator: Ninja
          - os: darwin
            arch: arm64
            runs-on: macos-latest
            file: libwebview.dylib
            args: -D CMAKE_OSX_ARCHITECTURES=arm64
            generator: Ninja
          - os: windows
            arch: amd64
            runs-on: windows-latest
            file: Release/webview.dll
            args: -A x64
          - os: windows
            arch: arm64
            runs-on: windows-latest
            file: Release/webview.dll
            args: -A ARM64
    steps:
      - uses: actions/checkout@v4
        with:
          repository: webview/webview
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Install dependencies
        if: matrix.job.os == 'linux'
        run: |
          sudo apt-get update 
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Configure and Build
        run: |
          gen_args=()
          if [ -n "${{ matrix.job.generator }}" ]; then
            if command -v ninja >/dev/null 2>&1; then
              gen_args=(-G "${{ matrix.job.generator }}")
            else
              echo "ninja not found on runner, using default cmake generator"
            fi
          fi

          clang_format_exe=""
          if command -v clang-format >/dev/null 2>&1; then
            clang_format_exe="$(command -v clang-format)"
          elif xcrun --find clang-format >/dev/null 2>&1; then
            clang_format_exe="$(xcrun --find clang-format)"
          elif command -v clang-format-18 >/dev/null 2>&1; then
            clang_format_exe="$(command -v clang-format-18)"
          else
            clang_format_exe="$RUNNER_TEMP/clang-format-noop"
            printf '%s\n' '#!/usr/bin/env bash' '# No-op fallback for environments without clang-format.' 'exit 0' > "$clang_format_exe"
            chmod +x "$clang_format_exe"
          fi
          echo "Using WEBVIEW_CLANG_FORMAT_EXE=$clang_format_exe"

          cmake "${gen_args[@]}" -B build -S . -D CMAKE_BUILD_TYPE=Release ${{ matrix.job.args }} \
            -D WEBVIEW_BUILD_SHARED_LIBRARY=ON \
            -D WEBVIEW_BUILD_STATIC_LIBRARY=OFF \
            -D WEBVIEW_BUILD_TESTS=OFF \
            -D WEBVIEW_BUILD_EXAMPLES=OFF \
            -D WEBVIEW_BUILD_DOCS=OFF \
            -D WEBVIEW_ENABLE_PACKAGING=OFF \
            -D WEBVIEW_ENABLE_CHECKS=OFF \
            -D WEBVIEW_CLANG_FORMAT_EXE="$clang_format_exe"
          cmake --build build --config Release

      - name: Rename artifact
        run: |
          artifact_name=$(basename "${{ matrix.job.file }}")
          src=""

          if [ -f "build/core/${{ matrix.job.file }}" ]; then
            src="build/core/${{ matrix.job.file }}"
          fi

          if [ -z "$src" ]; then
            src=$(find build -type f \( -path "*/${{ matrix.job.file }}" -o -name "$artifact_name" \) | head -n1 || true)
          fi

          if [ -z "$src" ]; then
            echo "failed to find built artifact for ${{ matrix.job.os }}_${{ matrix.job.arch }} (${{ matrix.job.file }})" >&2
            echo "files found under build/:" >&2
            find build -type f | sort >&2
            exit 1
          fi

          mkdir -p ${{ matrix.job.os }}_${{ matrix.job.arch }}
          cp "$src" ${{ matrix.job.os }}_${{ matrix.job.arch }}/"$artifact_name"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.job.os }}_${{ matrix.job.arch }}
          path: ${{ matrix.job.os }}_${{ matrix.job.arch }}/*

  finalize:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.skip != 'true'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: embedded

      - name: Create version file
        run: echo -n "${{ needs.prepare.outputs.version }}" > embedded/VERSION.txt

      - name: Commit and create PR
        uses: peter-evans/create-pull-request@v7
        with:
          branch: update-webview
          sign-commits: true
          commit-message: 'feat: update webview to ${{ needs.prepare.outputs.version }}'
          title: 'feat: update webview to ${{ needs.prepare.outputs.version }}'
          body: |
            This PR updates embedded WebView native libraries to `${{ needs.prepare.outputs.version }}`.

            Upstream commit: https://github.com/webview/webview/commit/${{ needs.prepare.outputs.ref }}
